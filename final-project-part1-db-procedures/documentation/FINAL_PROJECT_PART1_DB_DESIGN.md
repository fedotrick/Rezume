# Итоговый проект. Часть 1 — Проектирование БД и хранимые процедуры

Система управления портфелями ценных бумаг предназначена для хранения структуры портфелей, сделок, котировок и связанных операций. Набор объектов в данной части включает таблицы, ограничения, индексы, примеры данных и пять хранимых процедур.

## Структура скриптов

| Файл | Назначение |
|------|------------|
| `scripts/final_project_part1_schema.sql` | Создание всех таблиц, ключей, индексов и ограничений. |
| `scripts/final_project_part1_procedures.sql` | Хранимые процедуры для управления сделками, аналитики и отчетности. |
| `scripts/final_project_part1_sample_data.sql` | Набор примерных данных для тестирования. |
| `scripts/final_project_part1_examples.sql` | Примеры запросов и вызовов процедур, демонстрирующие использование объекта. |

> Рекомендуемый порядок выполнения: `schema` → `procedures` → `sample_data`.

## Описание таблиц

### `dbo.Securities`
- **Назначение:** справочник ценных бумаг.
- **Ключи:** `SecurityID` — PK, `Ticker` — уникальный индекс.
- **Контроль целостности:** тип инструмента ограничен набором значений; тикер, наименование, сектор обязательны.
- **Индексы:** дополнительный индекс по паре (Sector, Type) для аналитических запросов.

### `dbo.Portfolios`
- **Назначение:** список клиентских портфелей.
- **Ключи:** `PortfolioID` — PK, (Owner, Name) — уникальная пара.
- **Контроль целостности:** `CreatedDate` заполняется автоматически; `Owner`, `Name` обязательны.
- **Индексы:** не кластерный индекс по владельцу для быстрых выборок.

### `dbo.Transactions`
- **Назначение:** хранение сделок BUY/SELL.
- **Связи:** FK на `Portfolios` (каскадное удаление) и `Securities`.
- **Контроль целостности:** Checks на положительные `Quantity`, `Price`, тип сделки (`BUY`/`SELL`).
- **Индексы:** по (PortfolioID, TransactionDate) и (SecurityID, TransactionDate) для отчетов и аналитики.

### `dbo.Quotes`
- **Назначение:** серия котировок по каждой ценной бумаге.
- **Связи:** FK на `Securities` с каскадным удалением.
- **Контроль целостности:** Checks на положительную цену и неотрицательный объем; уникальность пары (SecurityID, QuoteDate).
- **Индексы:** по (SecurityID, QuoteDate DESC) для выбора последней котировки.

### `dbo.Operations`
- **Назначение:** дополнительные финансовые операции по портфелю (депозиты, комиссии и т.д.).
- **Связи:** FK на `Portfolios` с каскадным удалением.
- **Контроль целостности:** сумма операции не может быть 0.
- **Индексы:** по (PortfolioID, OperationDate DESC).

### `dbo.Audit_Log`
- **Назначение:** журнал действий и ошибок процедур.
- **Контроль целостности:** обязательные поля `TableName`, `Action` и дата изменения.
- **Индексы:** по (TableName, ChangeDate DESC) для анализа истории изменений.

## Хранимые процедуры

### `dbo.sp_AddTransaction`
- **Параметры:** `@PortfolioID`, `@SecurityID`, `@Quantity`, `@Price`, `@TransactionDate` (опционально), `@Type`, `@Result OUTPUT`, `@TransactionID OUTPUT`.
- **Логика:**
  1. Проверка существования портфеля и ценной бумаги.
  2. Проверка допустимых значений количества, цены и типа сделки.
  3. Добавление сделки в транзакции с логированием в `Audit_Log`.
  4. Обработка ошибок в блоке TRY/CATCH, откат транзакции и запись ошибки в `Audit_Log`.
- **Результат:** выходные параметры `@Result = 'SUCCESS'|'FAILED'` и идентификатор вставленной сделки.

### `dbo.sp_UpdatePortfolioValue`
- **Параметры:** `@PortfolioID`.
- **Логика:**
  - Агрегирование чистых позиций по портфелю и умножение на последнюю доступную котировку каждой бумаги.
- **Результат:** один набор данных с полями `PortfolioID`, `PortfolioValue`, `SnapshotDate`.

### `dbo.sp_GetPortfolioAnalytics`
- **Параметры:** `@PortfolioID`.
- **Логика:**
  - Расчет совокупной стоимости портфеля и метрик.
  - Подготовка распределения стоимости по типам инструментов.
  - Выдача детализированного списка бумаг с долями.
- **Результат:** три набора данных:
  1. Общая аналитика по портфелю.
  2. Распределение по типам бумаг.
  3. Детализация по каждой бумаге.

### `dbo.sp_RebalancePortfolio`
- **Параметры:** `@PortfolioID`, `@TargetAllocation` (JSON-массив вида `[{"SecurityID": 1, "TargetPercent": 40.0}, ...]`).
- **Логика:**
  1. Калибровка входного JSON, проверка суммы долей (100%).
  2. Расчет текущих стоимостей и долей портфеля.
  3. Сравнение целевых значений с текущими и определение необходимого объема сделок.
- **Результат:**
  - Первый набор данных — сводка (текущая стоимость портфеля, количество позиций и целевых записей).
  - Второй набор данных — план ребалансировки с колонками `ActionRequired` и `QuantityToTrade`.
  - При отсутствии котировки для бумаги действие помечается `REVIEW`.

### `dbo.sp_GenerateReport`
- **Параметры:** `@PortfolioID`, `@StartDate`, `@EndDate`.
- **Логика:**
  - Отбор сделок за указанный период, расчет денежных потоков и ROI.
  - Подтягивание текущей стоимости портфеля для учета нереализованных позиций.
  - Отдельный вывод операций из таблицы `Operations` за период.
- **Результат:**
  1. Сводка по периодy (инвестиции, поступления, PnL, ROI).
  2. Детализация сделок с суммами и денежными потоками.
  3. Финансовые операции (`Operations`).

## Примеры вызовов процедур

```sql
DECLARE @Result NVARCHAR(20),
        @NewTransactionID BIGINT;

EXEC dbo.sp_AddTransaction
    @PortfolioID     = 1,
    @SecurityID      = 1,
    @Quantity        = 12.5,
    @Price           = 188.45,
    @TransactionDate = '2024-05-15T14:30:00',
    @Type            = N'BUY',
    @Result          = @Result OUTPUT,
    @TransactionID   = @NewTransactionID OUTPUT;

SELECT @Result AS Result, @NewTransactionID AS TransactionID;
```

```sql
EXEC dbo.sp_UpdatePortfolioValue @PortfolioID = 1;
```

```sql
EXEC dbo.sp_GetPortfolioAnalytics @PortfolioID = 1;
```

```sql
DECLARE @Target NVARCHAR(MAX) = N'[
  {"SecurityID": 1, "TargetPercent": 35.0},
  {"SecurityID": 2, "TargetPercent": 35.0},
  {"SecurityID": 4, "TargetPercent": 30.0}
]';

EXEC dbo.sp_RebalancePortfolio
    @PortfolioID = 2,
    @TargetAllocation = @Target;
```

```sql
EXEC dbo.sp_GenerateReport
    @PortfolioID = 3,
    @StartDate   = '2024-01-01T00:00:00',
    @EndDate     = '2024-04-30T23:59:59';
```

## Дополнительные рекомендации

- Скрипты рассчитаны на выполнение в базе данных SQL Server (версия 2017+), так как используются `DATETIME2`, `SYSUTCDATETIME()`, `OPENJSON` и `CREATE OR ALTER`.
- Для работы с JSON-параметрами в `sp_RebalancePortfolio` требуется включенная совместимость с SQL Server 2016+.
- При необходимости интеграции с приложением рекомендуется обернуть выполнение процедур в бизнес-логику, добавив обработку возвращаемых наборов данных и параметров.
- Таблица `Audit_Log` предназначена для хранения истории вставок и ошибок, генерируемых процедурами, и может быть расширена при интеграции с механизмами аудита безопасности.
