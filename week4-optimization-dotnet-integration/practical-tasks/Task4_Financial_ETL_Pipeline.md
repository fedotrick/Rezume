# Задача 4. ETL-процесс для финансовых данных

## Цель

Создать устойчивый ETL-конвейер для загрузки, валидации и расчёта ключевых метрик по сделкам, оптимизированный под большие объёмы данных.

## Исходные данные

- Структуры таблиц и шаблоны процедур в `scripts/week4_optimization_examples.sql` (раздел *Scenario 3*).
- Вход: файлы с данными о сделках (`Deals_YYYYMMDD.json/csv`).
- Требования к отчёту: агрегаты по портфелям, направлениям торговли, валютам.

## Этапы выполнения

1. **Архитектура ETL**.
   - Определите слои: `Landing` (сырые данные), `Staging`, `Core`, `Mart`.
   - Запланируйте расписание (ежедневно/ежечасно).
   - Настройте контроль качества (row count, checksum, статистика ошибок).

2. **Загрузка Landing → Staging**.
   - Используйте `BULK INSERT`, `OPENROWSET(BULK...)` или внешние таблицы PolyBase.
   - Заносите метаданные загрузки в `dbo.EtlLoadLog` (файл, источник, статус).
   - Валидация минимального набора полей, разбивка ошибок по типам (некорректная дата, отрицательная сумма).

3. **Очистка и трансформация**.
   - Нормализуйте валюты, преобразуйте временные зоны.
   - Примените справочники (инструменты, портфели, трейдеры).
   - Используйте batch-подход (порции по 5k-20k строк).

4. **Расчёт агрегатов**.
   - Суточный оборот, средняя цена, PnL (`SoldAmount - BoughtAmount`), позиция по инструментам.
   - Записывайте результаты в `dbo.TradeAggregates` и `dbo.PortfolioPerformance`.
   - Для тяжёлых расчётов используйте columnstore/partitioned таблицы.

5. **Загрузка Mart**.
   - Создайте представления или материализованные таблицы для BI/отчётности.
   - Оптимизируйте индексы под аналитические запросы.

6. **Мониторинг и ошибки**.
   - Настройте алерты на превышение порога ошибок, отклонение по количеству записей.
   - Реализуйте повтор загрузки с идемпотентностью (по ключу файла или дате).

7. **Документирование**.
   - Описывайте источники, шаги трансформации, контрольные измерения.
   - Добавьте диаграмму потока данных и runbook (план действий при сбое).

## Ожидаемый результат

- Автоматизированный ETL-процесс, обрабатывающий ≥ 1 млн записей за цикл < 10 минут.
- Заполненные таблицы агрегатов и отчётных витрин.
- Логи загрузки, позволяющие отследить статус и обработать ошибки.
- Документация: схема данных, последовательность шагов, RTO/RPO.

## Дополнительные материалы

- Лекции 2 и 3 (batch-обработка, интеграция .NET, обработка ошибок).
- `BEST_PRACTICES_AND_RECOMMENDATIONS.md`, разделы «Batch-обработка», «Production Deployment», «Обработка ошибок».
- Документация: [SQL Server Integration Services](https://learn.microsoft.com/sql/integration-services/), [Azure Data Factory](https://learn.microsoft.com/azure/data-factory/).
