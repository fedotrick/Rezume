# Задача 2. Работа с большими объёмами данных

## Цель

Импортировать набор из 10+ миллионов строк финансовых транзакций, реализовать batch-обработку ключевых расчётов и оптимизировать время выполнения за счёт партиционирования и архивирования.

## Исходные данные

- Набор CSV-файлов с данными о сделках (`trades_2024_Q*.csv`).
- Скрипты заготовок: `scripts/week4_optimization_examples.sql` (раздел *Scenario 2*).
- Выделенная файловая группа `FGArchive` для архивов.

## Этапы выполнения

1. **Подготовка инфраструктуры**.
   - Создайте staging-таблицу `dbo.TradesStage`.
   - Настройте partition function `PF_TradesByMonth` и scheme `PS_TradesByMonth`.
   - Создайте основную таблицу `dbo.TradesFact` на partition scheme.

2. **Импорт данных**.
   - Используйте `BULK INSERT` или `SqlBulkCopy` для загрузки CSV-файлов порциями по 50k–200k строк.
   - Логируйте каждый импорт в таблицу прогресса `dbo.ImportLog` (файл, количество строк, время).

3. **Валидация и очистка**.
   - Проверяйте обязательные поля (`PortfolioId`, `TradeDate`, `Symbol`, `Quantity`).
   - Отбрасывайте записи с некорректными датами/значениями.
   - Заполняйте таблицу ошибок `dbo.TradesStageErrors`.

4. **Batch-обработка расчётов**.
   - Переносите валидные данные из `TradesStage` в `TradesFact` партиями по `@BatchSize` (см. шаблон в скрипте).
   - Рассчитывайте агрегаты (суточный оборот, средняя цена) и записывайте в `dbo.TradeAnalytics`.

5. **Архивирование**.
   - Перемещайте разделы старше 24 месяцев в архивную таблицу `dbo.TradesArchive` через `ALTER TABLE ... SWITCH PARTITION`.
   - Создайте задачу SQL Agent / расписание для ежемесячного архивирования.

6. **Оптимизация**.
   - Проверьте индексы для активных данных (фильтрованные).
  - Перепроверьте статистику после массовой загрузки (`sp_updatestats`).
   - Зафиксируйте показатели времени выполнения импорта и расчётов.

## Ожидаемый результат

- Загружено ≥ 10 000 000 записей без потери качества данных.
- Batch-процесс переводит записи из staging в основную таблицу без блокировок, время цикла < 10 секунд.
- Архивирование старых данных выполнено, активная часть базы сокращена.
- Документ с описанием архитектуры, параметров batch'ей, графиков выполнения.

## Дополнительные материалы

- Лекция 2 (partitioning, columnstore, bulk-операции).
- `BEST_PRACTICES_AND_RECOMMENDATIONS.md`, разделы «Batch-обработка» и «Production Deployment».
- Документация: [BULK INSERT](https://learn.microsoft.com/sql/t-sql/statements/bulk-insert-transact-sql), [Partitioned Tables and Indexes](https://learn.microsoft.com/sql/relational-databases/partitions/partitioned-tables-and-indexes).
