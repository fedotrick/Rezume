# Задача 5. Финансовый отчёт по портфелям

## Цель

Создать набор оптимизированных SQL-запросов для расчёта метрик портфелей, анализировать доходность за разные периоды и сравнивать портфели между собой.

## Исходные данные

- Таблицы: `Portfolios`, `PortfolioHoldings`, `PortfolioPerformance`, `DailyPrices`, `FxRates`.
- Представления для отчётов создаются скриптом `scripts/week4_optimization_examples.sql` (раздел *Scenario 4*).
- Требования: отчёт по NAV, доходности (дн/нед/мес/год), риску, сравнению портфелей.

## Этапы выполнения

1. **Навигация и модель данных**.
   - Ознакомьтесь со схемой (ER-диаграмма в приложении к скрипту).
   - Определите, какие таблицы содержат факты (NAV, обороты) и измерения (портфели, валюта, инструмент).

2. **Расчёт NAV и доходности**.
   - Запрос `vw_PortfolioNavDaily` для ежедневного NAV.
   - Дополняйте его вычислением дневной, месячной, годовой доходности (используйте `LAG`, `AVG`).

3. **Метрики риска**.
   - Рассчитайте волатильность (`SQRT(VARP(...)) * SQRT(252)`).
   - Выполните сравнение портфелей по `Sharpe Ratio` (доходность – ставка без риска / волатильность).

4. **Сравнение портфелей**.
   - Постройте матрицу корреляций (позиции портфелей, доходности).
   - Отобразите лидеров/аутсайдеров по доходности и риску.
   - Разработайте запрос для выявления отклонений от целевых весов.

5. **Оптимизация**.
   - Проанализируйте планы выполнения, добавьте индексы (`PortfolioId`, `TradeDate`).
   - Используйте агрегированные таблицы (pre-calculated факты) вместо расчётов «на лету».
   - Для часто используемых отчётов рассмотрите materialized views (indexed views).

6. **Визуализация (опционально)**.
   - Подготовьте выгрузку в формат CSV/Parquet для BI-инструментов.
   - Создайте скрипт формирования отчёта (Power BI, Excel Power Query).

## Ожидаемый результат

- Набор оптимизированных SQL-запросов/представлений для ключевых метрик портфелей.
- Таблица сравнения портфелей с доходностью, волатильностью, Sharpe Ratio.
- Документация о созданных индексах и их влиянии на планы выполнения.
- Вариант визуализации или описание подключения BI-решений.

## Дополнительные материалы

- Лекция 4 (финансовые метрики и SQL-примеры).
- `BEST_PRACTICES_AND_RECOMMENDATIONS.md`, разделы «Индексация», «Мониторинг и алертинг».
- Документация: [Window Functions](https://learn.microsoft.com/sql/t-sql/queries/select-over-clause), [Indexed Views](https://learn.microsoft.com/sql/relational-databases/views/create-indexed-views).
