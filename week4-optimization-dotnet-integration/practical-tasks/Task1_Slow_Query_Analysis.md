# Задача 1. Анализ и оптимизация медленного запроса

## Цель

Идентифицировать причины медленной работы запроса к финансовым данным, проанализировать план выполнения и реализовать оптимизации (индексы, переписывание, статистика), сравнив результаты до и после.

## Исходные данные

- База данных `SQLTrading` с таблицами `TradesFact`, `Portfolios`, `DailyPrices`.
- Эталонные скрипты в файле `scripts/week4_optimization_examples.sql` (раздел *Scenario 1*).

## Этапы выполнения

1. **Получите исходное время выполнения**.
   - Запустите запрос из скрипта «Step 1: Baseline».
   - Включите `SET STATISTICS IO, TIME ON`, сохраните результаты в файл.
   - Снимите Actual Execution Plan (`CTRL+M`).

2. **Проанализируйте план**.
   - Определите отдельные операторы с наибольшей Estimated Subtree Cost.
   - Проверьте предупреждения (missing indexes, конверсия типов, spills).
   - Зафиксируйте фактическое количество строк на каждом операторе.

3. **Предложите оптимизацию**.
   - Рассмотрите составные индексы (`PortfolioId`, `TradeDate`).
   - Перенесите агрегацию в CTE или убедитесь, что фильтры используют индексы.
   - При необходимости перепишите запрос, чтобы уменьшить количество `LOOKUP`.

4. **Примените изменения**.
   - Создайте индексы из раздела «Step 2: Index Proposal» (или разработайте свои).
   - Обновите статистику, если требуется (`UPDATE STATISTICS`).

5. **Измерьте улучшение**.
   - Повторно выполните запрос (раздел «Step 3: Optimized Query»).
   - Сравните логические чтения, CPU time и общее время.
   - Сохраните оба `.sqlplan` и результаты в таблицу/файл отчёта.

## Ожидаемый результат

- Отдельный документ/файл с:
  - Планом выполнения до и после.
  - Таблицей сравнения метрик (logical reads, CPU, duration).
  - Описанием применённых изменений и их эффекта.
- Улучшение по времени выполнения не менее чем в 5 раз (ориентир — со 1200 мс до 200 мс).

## Дополнительные материалы

- Лекция 1 (анализ execution plan).
- `BEST_PRACTICES_AND_RECOMMENDATIONS.md`, раздел «Анализ и стабильность планов выполнения».
- Query Store / Extended Events для валидации улучшений на длительном периоде.
