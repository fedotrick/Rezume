# Лекция 1. План выполнения запросов (Execution Plan)

## Цели занятия

- Научиться читать графические и текстовые планы выполнения в SQL Server Management Studio (SSMS).
- Понимать ключевые операторы плана: сканы, поиск по индексу, типы соединений, операции сортировки и агрегирования.
- Оценивать стоимость операций, выявлять «дорогие» участки запроса и принимать решение об оптимизации.
- Использовать инструменты профилирования: Actual Execution Plan, Live Query Statistics, SQL Profiler и Extended Events.

## 1. Получение плана выполнения

### 1.1. Актуальный (Actual) vs. Ожидаемый (Estimated)

| Тип | Команда | Когда использовать |
|-----|---------|--------------------|
| **Estimated Execution Plan** | `CTRL + L` или `SET SHOWPLAN_XML ON` | Быстрый анализ без запуска запроса (без фактического выполнения) |
| **Actual Execution Plan** | `CTRL + M` или кнопка *Include Actual Execution Plan* | Когда нужна фактическая статистика (количество строк, предупреждения) |

```sql
USE SQLTraining;
GO

-- Пример получения ожидаемого плана
SET SHOWPLAN_XML ON;
SELECT TOP 100 *
FROM dbo.Trades t
WHERE t.TradeDate >= '2024-01-01';
SET SHOWPLAN_XML OFF;
GO

-- Пример получения фактического плана
SET STATISTICS IO, TIME ON;
SELECT TOP 100 *
FROM dbo.Trades t
WHERE t.TradeDate >= '2024-01-01';
SET STATISTICS IO, TIME OFF;
GO
```

### 1.2. Анализ Live Query Statistics

Live Query Statistics отображает фактический прогресс выполнения запроса и полезна при долгих запусках ETL или аналитических отчётов. Включается в SSMS (меню **Query** → *Include Live Query Statistics*).

## 2. Основные операторы плана

| Оператор | Что делает | На что обращать внимание |
|----------|-------------|----------------------------|
| **Clustered Index Scan / Table Scan** | Последовательное чтение всей таблицы | Соответствует ли фильтр индексу? Нужен ли покрывающий индекс? |
| **Index Seek** | Поиск по не кластерному индексу | Нет ли lookup'ов? Совпадает ли порядок колонок с фильтрацией? |
| **RID Lookup / Key Lookup** | Дозапрос данных в кластерный индекс | Рассмотрите включённые колонки или перекрывающий индекс |
| **Nested Loops** | Поэлементное соединение (оптимально при малых наборах) | Дорогой при большом внешнем наборе. Проверяйте количество итераций |
| **Hash Match** | Хэш-соединение / агрегат | Требует tempdb, чувствителен к памяти. Важны предупреждения (hash spill) |
| **Merge Join** | Порядковое объединение отсортированных наборов | Требует предсортированных данных или сортировки |
| **Sort** | Упорядочивание набора | Высокая стоимость и возможные spill'ы в tempdb |
| **Parallelism** | Распараллеливание запроса | Следите за skew и затратами на redistribuцию |

## 3. Стоимость операций и метрика Cost

- **Estimated Subtree Cost** показывает относительную (не абсолютную) стоимость ветви плана.
- **Estimated vs. Actual Rows**: большое расхождение указывает на устаревшие статистики, неподходящие индексы или параметрический сникер.
- Предупреждения на операторе (`⚠️` в SSMS) сигнализируют о проблемах: отсутствующие статистики, конвертация типов, spill в tempdb, план, требующий attention.

### Пример дешифровки

```
Hash Match (Hash) (Cost = 62%, Estimated Rows = 1 200 000, Actual Rows = 10 000)
  -> Index Scan (Cost = 38%, Estimated Rows = 1 200 000, Actual Rows = 1 200 000)
```

Интерпретация:
- Hash Match занимает 62% стоимости плана, однако фактически вернул всего 10k строк вместо ожидаемых 1.2M.
- Требуется обновить статистики или переписать запрос, чтобы сократить входной поток (например, добавить фильтр или индекс).

## 4. Инструменты анализа в SSMS

1. **Properties окно** — показывает CardinalityEstimationModelVersion, количество логических чтений, количество параллельных потоков.
2. **Compare Showplan** — сравнение планов (правый клик по плану → *Compare Showplan*). Удобно при сравнении до/после оптимизации.
3. **Plan Explorer (SentryOne)** — сторонний инструмент с дополнительной визуализацией.

## 5. Профилирование: SQL Profiler и Extended Events

- **SQL Profiler** (legacy) подходит для локальных тестов и обучения, но не рекомендуется для production.
- **Extended Events** — современная альтернатива для захвата долгих запросов (`duration`, `cpu_time`, `logical_reads`).
- **Query Store** — источник исторических данных и регрессий.

Пример сессии Extended Events для долгих запросов:

```sql
CREATE EVENT SESSION LongRunningQueries
ON SERVER
ADD EVENT sqlserver.rpc_completed(
    WHERE duration > 5000000
),
ADD EVENT sqlserver.sql_batch_completed(
    WHERE duration > 5000000
)
ADD TARGET package0.event_file (SET filename = 'C:\XE\LongRunningQueries.xel')
WITH (MAX_MEMORY = 4096 KB, EVENT_RETENTION_MODE = ALLOW_SINGLE_EVENT_LOSS);
GO
ALTER EVENT SESSION LongRunningQueries ON SERVER STATE = START;
```

## 6. Кейсы оптимизации на основе плана

1. **Table Scan → Index Seek**: добавление составного индекса по фильтру и сортировке.
2. **Hash Match spill**: увеличение памяти (`RESOURCE GOVERNOR`), предварительная сортировка данных, переписанный запрос.
3. **Parameter Sniffing**: внедрение `OPTION (RECOMPILE)` для одноразовых отчётов или `OPTIMIZE FOR UNKNOWN`.
4. **Missing Index**: анализ рекомендаций в плане, оценка среднего выигрыша, проверка коллатерали на вставки/обновления.

## 7. Контрольный список

- [ ] Получили и сохранили план выполнения (estimated + actual).
- [ ] Идентифицировали самые дорогие операторы и их причины.
- [ ] Проверили предупреждения, параллелизм и расхождения по cardinality.
- [ ] Подготовили гипотезы по оптимизации (индекс, переписывание, статистика).
- [ ] Задокументировали результаты, приложив `.sqlplan` и метрики до/после.

Изучение планов выполнения — основа системной оптимизации. Освоив их чтение, вы сможете быстро локализовать узкие места и предложить аргументированные улучшения.
